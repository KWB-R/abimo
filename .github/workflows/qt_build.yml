name: QT Build

on: [push, pull_request]

jobs:
  windows:
    name: Windows
    runs-on: windows-latest
    env:
      ARCHIVE_NAME: abimo_latest_windows
    steps:
      - name: MSVC Environment Setup
        uses: ilammy/msvc-dev-cmd@v1.11.0
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
      - name: Run QMake
        run: qmake src/app/app.pro
      - name: Build
        run: nmake release
      - name: Deploy
        run: windeployqt.exe release        
      - name: Rename release directory
        run: rename release ${{ env.ARCHIVE_NAME }}
        shell: cmd
      - name: Create zip-file
        shell: pwsh
        run: Compress-Archive -Path ${{ env.ARCHIVE_NAME }} -DestinationPath ${{ env.ARCHIVE_NAME }}.zip
      - name: List files
        shell: cmd
        run: dir /s /b
      - name: Update Windows-related asset in latest release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: latest-1
          files: ${{ env.ARCHIVE_NAME }}.zip
  linux:
    name: Linux Ubuntu
    runs-on: ubuntu-20.04
#    runs-on: ubuntu-22.04
    env:
      ARCHIVE_NAME: abimo_latest_linux
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
      - name: Run QMake
        run: qmake src/app/app.pro
      - name: Build
        run: make
      - name: Create archive and list files
        run: |
          mv release ${{ env.ARCHIVE_NAME }}
          tar -czvf ${{ env.ARCHIVE_NAME }}.tar.gz ${{ env.ARCHIVE_NAME }}
          ls -l
      - name: Update Linux-related asset in latest release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: latest-1
          files: ${{ env.ARCHIVE_NAME }}.tar.gz
  macos:
    name: macOS
    runs-on: macos-latest
    env:
      ARCHIVE_NAME: abimo_latest_macos
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
      - name: Run QMake
        run: qmake src/app/app.pro
      - name: Build
        run: make        
      - name: Create archive and list files
        run: |
          mv release ${{ env.ARCHIVE_NAME }}
          tar -czvf ${{ env.ARCHIVE_NAME }}.tar.gz ${{ env.ARCHIVE_NAME }}
          ls -l
      - name: Update macOS-related asset in latest release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: latest-1
          files: ${{ env.ARCHIVE_NAME }}.tar.gz
